# Multi‑Phase Migration Plan

Target signature (example):
- Before: `func (s *SampleService) Hello(ctx context.Context, req *dto.HelloRequest) (*dto.HelloResponse, error)`
- After: `func (s *SampleService) Hello(ctx context.Context, req *endpoint.HTTPRequest[*sampleService.HelloRequest]) (*endpoint.HTTPResponse[*grabservicepb.HelloResponse], error)`

We will apply this pattern to all service methods with minimal handler/test changes. Business logic must remain identical.

Phases

## Phase 0 — Baseline snapshot
Deliverables:
- [business-rules.md](./business-rules.md) (this table)
- specs/migration/tools/ast-baseline.json (tree-sitter-go dump; generated by CLI)
- [progress.md](./progress.md) initialized
Commands:
- `make test`
- Generate AST/rules JSON via ParserAgent (tree-sitter-go)

## Phase 1 — Endpoint shims and helpers (no behavior change)
Files:
- internal/compat/endpoint_shims.go
  - `type HTTPRequest[T any] = endpoint.HTTPRequest[*T]`
  - `type HTTPResponse[T any] = endpoint.HTTPResponse[*T]`
  - `func WrapReq[T any](v *T) *HTTPRequest[T]`
  - `func UnwrapResp[T any](r *HTTPResponse[T]) *T`
Gates:
- `make build && make test`

## Phase 2 — ProductService migration
Changes:
- Update signatures in [product_service.go](file:///Users/isurufonseka/grab/example-ecom-go-api/internal/services/product_service.go) to use `*compat.HTTPRequest[...]` and return `*compat.HTTPResponse[...]`.
- Use `req.Body` fields; wrap return values in `&compat.HTTPResponse[...]`.
- Update product handlers and [product_service_test.go](file:///Users/isurufonseka/grab/example-ecom-go-api/internal/services/product_service_test.go) to use `compat.WrapReq`/`compat.UnwrapResp`.
Gates:
- Build + service/handler tests, then full test suite.

## Phase 3 — CartService migration
Changes:
- Update [cart_service.go](file:///Users/isurufonseka/grab/example-ecom-go-api/internal/services/cart_service.go) method signatures similarly (AddToCart, RemoveFromCart, GetCart).
- Update cart handlers and [cart_service_test.go](file:///Users/isurufonseka/grab/example-ecom-go-api/internal/services/cart_service_test.go).
Gates:
- Build + tests.

## Phase 4 — OrderService migration
Changes:
- Update [order_service.go](file:///Users/isurufonseka/grab/example-ecom-go-api/internal/services/order_service.go) (PlaceOrder) and related handlers/tests ([order_service_test.go](file:///Users/isurufonseka/grab/example-ecom-go-api/internal/services/order_service_test.go)).
Gates:
- Build + tests.

## Phase 5 — Validation and cleanup
Deliverables:
- specs/migration/tools/impldrift (tree-sitter-go based drift validator)
- Optional: remove compat aliases if replaced with direct endpoint.* usage.
Gates:
- `go run ./specs/migration/tools/impldrift validate --baseline specs/migration/tools/ast-baseline.json`

Subagents
- ParserAgent: AST and rule extraction
- MigrationAgent: service signature changes
- TestAgent: handler/test adjustments
- ValidationAgent: CLI for drift/scope checks
- ScopeAgent: exported API diffs vs baseline

Verification at end of each phase
- `make build`
- `make test`
- (Phase 5+) `go run ./cmd/impldrift validate`
